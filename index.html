<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>Gate 異常監控</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  margin: 0;
  background: #0b0f14;
  color: #e5e7eb;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
}
.container {
  padding: 20px;
  max-width: 1200px;
  margin: auto;
}
h1 {
  color: #60a5fa;
  margin-bottom: 8px;
}
small {
  color: #9ca3af;
}
.mode {
  margin: 12px 0;
}
.mode button {
  background: #1f2937;
  border: 1px solid #374151;
  color: #e5e7eb;
  padding: 6px 12px;
  margin-right: 6px;
  cursor: pointer;
}
.mode button.active {
  background: #2563eb;
}
.status {
  margin: 12px 0;
  font-weight: bold;
}
.warn {
  background: #3f2d00;
  color: #facc15;
  padding: 8px;
  margin-bottom: 12px;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 10px;
  border-bottom: 1px solid #1f2937;
}
th {
  text-align: left;
  color: #9ca3af;
}
.long { color: #22c55e; }
.short { color: #ef4444; }
.neutral { color: #facc15; }
.badge {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
}
.ok { background: #065f46; }
.try { background: #78350f; }
.no { background: #374151; }
</style>
</head>

<body>
<div class="container">
  <h1>Gate 異常監控</h1>
  <small id="updateTime">讀取中...</small>

  <div class="mode">
    模式：
    <button onclick="setMode('strict')" class="active">保守</button>
    <button onclick="setMode('normal')">正常</button>
    <button onclick="setMode('aggressive')">激進</button>
  </div>

  <div id="direction" class="status"></div>
  <div id="warning" class="warn" style="display:none;"></div>

  <table>
    <thead>
      <tr>
        <th>幣種</th>
        <th>方向</th>
        <th>變動</th>
        <th>價格</th>
        <th>強度</th>
        <th>操作建議</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
let MODE = 'strict';

const MODE_RULES = {
  strict:   { ok: 70, try: 45 },
  normal:   { ok: 60, try: 35 },
  aggressive:{ ok: 50, try: 25 }
};

function setMode(m) {
  MODE = m;
  document.querySelectorAll('.mode button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  render(window._data || []);
}

function taiwanTime(ts) {
  const d = new Date(ts);
  return d.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' });
}

async function load() {
  const res = await fetch('data_fast.json?_=' + Date.now());
  const json = await res.json();
  window._data = json.items || [];
  document.getElementById('updateTime').innerText =
    '最後更新：' + taiwanTime(json.updated);
  render(window._data);
}

function render(items) {
  const rules = MODE_RULES[MODE];
  const rows = document.getElementById('rows');
  rows.innerHTML = '';

  let bias = 0;

  const list = items.map(i => {
    let dir = 'neutral';
    if (i.change > 0.3) dir = 'long';
    if (i.change < -0.3) dir = 'short';

    let entry = '禁止';
    if (i.strength >= rules.ok) entry = '可做';
    else if (i.strength >= rules.try) entry = '小倉試單';

    if (dir === 'long') bias++;
    if (dir === 'short') bias--;

    return { ...i, dir, entry };
  }).filter(i => i.entry !== '禁止')
    .sort((a,b) => b.strength - a.strength)
    .slice(0, 15);

  list.forEach(i => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i.symbol}</td>
      <td class="${i.dir}">${i.dir}</td>
      <td>${i.change.toFixed(2)}%</td>
      <td>$${i.price}</td>
      <td>${i.strength}</td>
      <td>
        <span class="badge ${i.entry==='可做'?'ok':'try'}">${i.entry}</span>
      </td>`;
    rows.appendChild(tr);
  });

  const dirText = bias > 2 ? '偏多' : bias < -2 ? '偏空' : '盤整';
  document.getElementById('direction').innerText =
    `目前方向：${dirText}｜模式：${MODE}`;

  const warn = document.getElementById('warning');
  if (dirText === '盤整') {
    warn.style.display = 'block';
    warn.innerText = '⚠ 方向不明確，僅供觀察，不建議重倉進場';
  } else {
    warn.style.display = 'none';
  }
}

// 自動刷新（30 秒）
load();
setInterval(load, 30000);
</script>
</body>
</html>
