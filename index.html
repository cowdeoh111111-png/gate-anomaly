<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>Gate 異常監控</title>
  <style>
    body {
      background: #0b0f14;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      padding: 24px;
    }
    h1 { color: #4da3ff; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #1f2937;
      text-align: left;
    }
    .long { color: #22c55e; }
    .short { color: #ef4444; }
    .neutral { color: #facc15; }
  </style>
</head>

<body>
  <h1>Gate 異常監控</h1>
  <div id="updated"></div>
  <div id="market" style="margin-top:8px;font-weight:bold;"></div>

  <table>
    <thead>
      <tr>
        <th>幣種</th>
        <th>方向</th>
        <th>變動</th>
        <th>價格</th>
        <th>強度</th>
        <th>操作建議</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <script>
    // ⬇⬇⬇ 這裡就是我叫你貼的地方 ⬇⬇⬇

    let mode = 'normal';

    function getMarketBias(items) {
      const btc = items.find(i => i.symbol === 'BTC_USDT');
      const eth = items.find(i => i.symbol === 'ETH_USDT');

      if (!btc || !eth) return { bias: '盤整', hint: '資料不足' };

      const btcUp = btc.change > 1;
      const btcDown = btc.change < -1;
      const ethUp = eth.change > 1;
      const ethDown = eth.change < -1;

      if (btcUp && ethUp) return { bias: '偏多', hint: '可順多' };
      if (btcDown && ethDown) return { bias: '偏空', hint: '只找空' };

      return { bias: '盤整', hint: '觀察為主' };
    }

    function analyze(item, marketBias) {
      const change = item.change;
      let direction = 'neutral';

      if (change > 2) direction = 'long';
      if (change < -2) direction = 'short';

      const strength = Math.min(100, Math.abs(change) * 2);

      let trap = false;
      if (marketBias.bias === '偏空' && direction === 'long' && change > 8) {
        trap = true;
      }

      let advice = '觀察';
      let reason = '盤整區間';

      if (trap) {
        advice = '不建議';
        reason = '逆主流拉升，疑似誘多';
      } else if (marketBias.bias === '偏多' && direction === 'long') {
        advice = strength >= 50 ? '可做' : '觀察';
        reason = '順主流偏多';
      } else if (marketBias.bias === '偏空' && direction === 'short') {
        advice = strength >= 50 ? '可做' : '觀察';
        reason = '順主流偏空';
      } else {
        reason = '方向不一致';
      }

      return { direction, strength: strength.toFixed(0), advice, reason };
    }

    async function load() {
      const res = await fetch('./data_fast.json?_=' + Date.now());
      const data = await res.json();

      document.getElementById('updated').textContent =
        '最後更新：' + (data.updated || '未知');

      const market = getMarketBias(data.items);
      document.getElementById('market').textContent =
        `目前方向：${market.bias}｜${market.hint}`;

      const tbody = document.getElementById('rows');
      tbody.innerHTML = '';

      data.items.forEach(item => {
        const a = analyze(item, market);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.symbol}</td>
          <td class="${a.direction}">${a.direction}</td>
          <td>${item.change.toFixed(2)}%</td>
          <td>$${item.price}</td>
          <td>${a.strength}</td>
          <td title="${a.reason}">${a.advice}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    load();
    setInterval(load, 30000);
  </script>
</body>
</html>
