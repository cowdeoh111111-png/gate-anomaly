<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>Gate 異常監控</title>
<style>
  body {
    background:#0b0f14;
    color:#e5e7eb;
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    padding:30px;
  }
  h1 {
    color:#4ea1ff;
    margin-bottom:5px;
  }
  .sub {
    color:#9ca3af;
    margin-bottom:20px;
  }
  .direction {
    margin:15px 0;
    font-size:18px;
  }
  .long { color:#22c55e; }
  .short { color:#ef4444; }

  .row {
    display:flex;
    justify-content:space-between;
    padding:12px 8px;
    border-bottom:1px solid #1f2937;
    align-items:center;
  }
  .symbol { width:140px; }
  .age { color:#9ca3af; font-size:13px; }
</style>
</head>
<body>

<h1>Gate 異常監控</h1>
<div class="sub" id="updated">最後更新：--</div>

<div class="direction" id="direction">方向計算中…</div>

<div id="list"></div>

<script>
async function load() {
  const res = await fetch("./data_fast.json?_=" + Date.now());
  const data = await res.json();

  /** 台灣時間 **/
  const updated = new Date();
  const twTime = updated.toLocaleString("zh-TW", { timeZone: "Asia/Taipei" });
  document.getElementById("updated").innerText = "最後更新：" + twTime;

  const now = Date.now();

  let longScore = 0;
  let shortScore = 0;

  data.items.forEach(i => {
    if (i.side === "long") longScore += i.score;
    if (i.side === "short") shortScore += i.score;
  });

  const total = longScore + shortScore || 1;
  const bias = longScore > shortScore ? "long" : "short";
  const confidence = Math.round(
    (Math.abs(longScore - shortScore) / total) * 100
  );

  const dirEl = document.getElementById("direction");
  dirEl.innerHTML = `
    目前方向：
    <span class="${bias}">
      ${bias === "long" ? "偏多" : "偏空"}
    </span>
    ｜信心 ${confidence}%
  `;

  const list = document.getElementById("list");
  list.innerHTML = "";

  data.items
    .filter(i => i.side === bias) // ✅ 只顯示順勢
    .forEach(i => {
      const ageMin = Math.floor((now - i.first_seen) / 60000);
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="symbol">${i.symbol}</div>
        <div class="${i.side}">${i.side.toUpperCase()}</div>
        <div>${i.change}%</div>
        <div>$${i.price}</div>
        <div class="age">${ageMin} 分鐘前</div>
      `;
      list.appendChild(row);
    });
}

load();
setInterval(load, 30000);
</script>

</body>
</html>
